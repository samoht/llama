#! /bin/sh

#########################################################################
#                                                                       #
#                            Objective Caml                             #
#                                                                       #
#            Xavier Leroy, projet Cristal, INRIA Rocquencourt           #
#                                                                       #
#   Copyright 1999 Institut National de Recherche en Informatique et    #
#   en Automatique.  All rights reserved.  This file is distributed     #
#   under the terms of the GNU Library General Public License, with     #
#   the special exception on linking described in file LICENSE.         #
#                                                                       #
#########################################################################

# $Id: configure 10626 2010-07-14 10:32:34Z xleroy $

configure_options="$*"
libdir=`llamac -where`
host_type=unknown
x11_include_dir=''
x11_lib_dir=''

# Parse command-line arguments

while : ; do
  case "$1" in
    "") break;;
    -libdir|--libdir)
        libdir=$2; shift;;
    -host*|--host*)
        host_type=$2; shift;;
    -x11include*|--x11include*)
        x11_include_dir=$2; shift;;
    -x11lib*|--x11lib*)
        x11_lib_dir=$2; shift;;
    *) echo "Unknown option \"$1\"." 1>&2; exit 2;;
  esac
  shift
done

# Sanity checks

case "$libdir" in
  /*) ;;
  "") ;;
   *) echo "The -libdir directory must be absolute." 1>&2; exit 2;;
esac

# Generate the files

cd config
rm -f Makefile
touch Makefile

# Write options to Makefile

echo "# generated by ./configure $configure_options" >> Makefile

# Where to install

echo "LIBDIR=$libdir" >> Makefile

# Determine the system type

if test "$host_type" = "unknown"; then
  if host_type=`./config.guess`; then :; else
    echo "Cannot guess host type"
    echo "You must specify one with the -host option"
    exit 2
  fi
fi
if host=`./config.sub $host_type`; then :; else
  echo "Please specify the correct host type with the -host option"
  exit 2
fi
echo "Configuring for a $host ..."

# Determine the location of X include files and libraries

x11_include="not found"
x11_link="not found"

for dir in \
    $x11_include_dir          \
                              \
    /usr/X11R7/include        \
    /usr/include/X11R7        \
    /usr/local/X11R7/include  \
    /usr/local/include/X11R7  \
    /opt/X11R7/include        \
                              \
    /usr/X11R6/include        \
    /usr/include/X11R6        \
    /usr/local/X11R6/include  \
    /usr/local/include/X11R6  \
    /opt/X11R6/include        \
                              \
    /usr/X11/include          \
    /usr/include/X11          \
    /usr/local/X11/include    \
    /usr/local/include/X11    \
    /opt/X11/include          \
                              \
    /usr/X11R5/include        \
    /usr/include/X11R5        \
    /usr/local/X11R5/include  \
    /usr/local/include/X11R5  \
    /usr/local/x11r5/include  \
    /opt/X11R5/include        \
                              \
    /usr/X11R4/include        \
    /usr/include/X11R4        \
    /usr/local/X11R4/include  \
    /usr/local/include/X11R4  \
                              \
    /usr/X386/include         \
    /usr/x386/include         \
    /usr/XFree86/include/X11  \
                              \
    /usr/include              \
    /usr/local/include        \
    /usr/unsupported/include  \
    /usr/athena/include       \
    /usr/lpp/Xamples/include  \
                              \
    /usr/openwin/include      \
    /usr/openwin/share/include \
    ; \
do
  if test -f $dir/X11/X.h; then
    x11_include=$dir
    break
  fi
done

if test "$x11_include" = "not found"; then
  x11_try_lib_dir=''
else
  x11_try_lib_dir=`echo $x11_include | sed -e 's|include|lib|'`
fi

for dir in \
    $x11_lib_dir          \
    $x11_try_lib_dir      \
                          \
    /usr/X11R6/lib64      \
    /usr/X11R6/lib        \
    /usr/lib/X11R6        \
    /usr/local/X11R6/lib  \
    /usr/local/lib/X11R6  \
    /opt/X11R6/lib        \
                          \
    /usr/X11/lib          \
    /usr/lib/X11          \
    /usr/local/X11/lib    \
    /usr/local/lib/X11    \
    /opt/X11/lib          \
                          \
    /usr/X11R5/lib        \
    /usr/lib/X11R5        \
    /usr/local/X11R5/lib  \
    /usr/local/lib/X11R5  \
    /usr/local/x11r5/lib  \
    /opt/X11R5/lib        \
                          \
    /usr/X11R4/lib        \
    /usr/lib/X11R4        \
    /usr/local/X11R4/lib  \
    /usr/local/lib/X11R4  \
                          \
    /usr/X386/lib         \
    /usr/x386/lib         \
    /usr/XFree86/lib/X11  \
                          \
    /usr/lib64            \
    /usr/lib              \
    /usr/local/lib        \
    /usr/unsupported/lib  \
    /usr/athena/lib       \
    /usr/lpp/Xamples/lib  \
    /lib/usr/lib/X11      \
                          \
    /usr/openwin/lib      \
    /usr/openwin/share/lib \
    ; \
do
  if test -f $dir/libX11.a || \
     test -f $dir/libX11.so || \
     test -f $dir/libX11.dll.a || \
     test -f $dir/libX11.dylib || \
     test -f $dir/libX11.sa; then
    if test $dir = /usr/lib; then
      x11_link="-lX11"
    else
      x11_libs="-L$dir"
      case "$host" in
        *-*-*bsd*) x11_link="-R$dir -L$dir -lX11";;
        *) x11_link="-L$dir -lX11";;
      esac
    fi
    break
  fi
done

if test "$x11_include" = "not found" || test "$x11_link" = "not found"
then
  echo "X11 not found, unable to continue."
  exit 2
fi

echo "Location of X11 include files: $x11_include/X11"
echo "Options for linking with X11: $x11_link"
if test "$x11_include" = "/usr/include"; then
  x11_include=""
else
  x11_include="-I$x11_include"
fi
echo "X11_INCLUDES=$x11_include" >> Makefile
echo "X11_LINK=$x11_link" >> Makefile

# Print a summary

echo
echo "** Configuration summary for the graphics library **"
echo
echo "        destination .............. $libdir"
echo "        options for compiling .... $x11_include"
echo "        options for linking ...... $x11_link"
echo
echo "** Configuration completed successfully **"
echo
